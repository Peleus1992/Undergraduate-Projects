<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">

<title>Hardware Abstraction Layer: micro-common.c Source File</title>

<LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">

</head><body>

<table border="0" cellspacing="0" cellpadding="0"  width=100%>

<tr>

<td><img src="ST_Logo.gif"></td>

<td> <div class="qindex">

<a class="qindex" href="index.html">Home</a>&nbsp;

 | &nbsp;<a class="qindex" href="modules.html">Modules</a>&nbsp;

 | &nbsp;<a class="qindex" href="annotated.html">Data Structures</a>&nbsp;

 | &nbsp;<a class="qindex" href="files.html">File List</a>&nbsp;

 | &nbsp;<a class="qindex" href="globals.html">Index</a></div>

</td>

</table>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>micro-common.c</h1><a href="micro-common_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00011"></a>00011 <span class="preprocessor">#include PLATFORM_HEADER</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="error_8h.html" title="Return codes for API functions and module definitions.">error.h</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="micro-common_8h.html">hal/micro/micro-common.h</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="cortexm3_2micro-common_8h.html" title="Utility and convenience functions for STM32W108 microcontroller, common to both the...">hal/micro/cortexm3/micro-common.h</a>&quot;</span>
<a name="l00015"></a>00015 
<a name="l00016"></a><a class="code" href="group__micro.html#ga7ea499662dd11955f9f3cc340e2455b8">00016</a> <span class="keywordtype">void</span> <a class="code" href="group__micro.html#ga7ea499662dd11955f9f3cc340e2455b8" title="Enables the watchdog timer.">halInternalEnableWatchDog</a>(<span class="keywordtype">void</span>)
<a name="l00017"></a>00017 {
<a name="l00018"></a>00018   <span class="comment">//Just to be on the safe side, restart the watchdog before enabling it</span>
<a name="l00019"></a>00019   <a class="code" href="regs_8h.html#a47778fdbeb4b310a042db4ca65828565">WDOG_RESET</a> = 1;
<a name="l00020"></a>00020   <a class="code" href="regs_8h.html#a6cde1d9f77cda404bcc79db1811e2371">WDOG_KEY</a> = 0xEABE;
<a name="l00021"></a>00021   <a class="code" href="regs_8h.html#a325d7685a842e29dbf0571b0f8387177">WDOG_CFG</a> = <a class="code" href="regs_8h.html#aec4918782389a92c47f0e0ae713a9991">WDOG_ENABLE</a>;
<a name="l00022"></a>00022 }
<a name="l00023"></a>00023 
<a name="l00024"></a><a class="code" href="group__micro.html#ga8a39a028776dc2065aa3f02c2a1fd1d6">00024</a> <span class="keywordtype">void</span> <a class="code" href="group__iar.html#ga8a39a028776dc2065aa3f02c2a1fd1d6" title="Macro to reset the watchdog timer. Note: be very very careful when using this as...">halInternalResetWatchDog</a>(<span class="keywordtype">void</span>)
<a name="l00025"></a>00025 {
<a name="l00026"></a>00026   <span class="comment">//Writing any value will restart the watchdog</span>
<a name="l00027"></a>00027   <a class="code" href="regs_8h.html#a47778fdbeb4b310a042db4ca65828565">WDOG_RESET</a> = 1;
<a name="l00028"></a>00028 }
<a name="l00029"></a>00029 
<a name="l00030"></a><a class="code" href="group__micro.html#ga81c4a9744062969d68ab3a3ce56286c5">00030</a> <span class="keywordtype">void</span> <a class="code" href="group__micro.html#ga81c4a9744062969d68ab3a3ce56286c5" title="Disables the watchdog timer.">halInternalDisableWatchDog</a>(<a class="code" href="group__iar.html#gae712ac7a6479b38bdbb3286e80b72049">int8u</a> magicKey)
<a name="l00031"></a>00031 {
<a name="l00032"></a>00032   <span class="keywordflow">if</span> (magicKey == <a class="code" href="group__micro.html#gabb42f7171eba6959a54c6e6d9aeca64e" title="The value that must be passed as the single parameter to halInternalDisableWatchDog()...">MICRO_DISABLE_WATCH_DOG_KEY</a>) {
<a name="l00033"></a>00033     <a class="code" href="regs_8h.html#a6cde1d9f77cda404bcc79db1811e2371">WDOG_KEY</a> = 0xDEAD;
<a name="l00034"></a>00034     <a class="code" href="regs_8h.html#a325d7685a842e29dbf0571b0f8387177">WDOG_CFG</a> = <a class="code" href="regs_8h.html#ac6891fa0c67a0592fc8fd06704a10358">WDOG_DISABLE</a>;
<a name="l00035"></a>00035   }
<a name="l00036"></a>00036 }
<a name="l00037"></a>00037 
<a name="l00038"></a><a class="code" href="group__micro.html#ga40ef36e606f612ca87090e43d2705ac2">00038</a> <span class="keywordtype">boolean</span> <a class="code" href="group__micro.html#ga40ef36e606f612ca87090e43d2705ac2" title="Determines whether the watchdog has been enabled or disabled.">halInternalWatchDogEnabled</a>(<span class="keywordtype">void</span>)
<a name="l00039"></a>00039 {
<a name="l00040"></a>00040   <span class="keywordflow">if</span>(<a class="code" href="regs_8h.html#a325d7685a842e29dbf0571b0f8387177">WDOG_CFG</a>&amp;<a class="code" href="regs_8h.html#aec4918782389a92c47f0e0ae713a9991">WDOG_ENABLE</a>) {
<a name="l00041"></a>00041     <span class="keywordflow">return</span> <a class="code" href="group__platform__common.html#gaa8cecfc5c5c054d2875c03e77b7be15d" title="An alias for one, used for clarity.">TRUE</a>;
<a name="l00042"></a>00042   } <span class="keywordflow">else</span> {
<a name="l00043"></a>00043     <span class="keywordflow">return</span> <a class="code" href="group__platform__common.html#gaa93f0eb578d23995850d61f7d61c55c1" title="An alias for zero, used for clarity.">FALSE</a>;
<a name="l00044"></a>00044   }
<a name="l00045"></a>00045 }
<a name="l00046"></a>00046 
<a name="l00047"></a><a class="code" href="group__micro.html#gab8c93b98c927cae04fd70c5446c0a310">00047</a> <span class="keywordtype">void</span> <a class="code" href="group__micro.html#gab8c93b98c927cae04fd70c5446c0a310" title="Configure an IO pin&amp;#39;s operating mode.">halGpioConfig</a>(<a class="code" href="group__iar.html#ga2ba8e0357fdc7b7a450e6893ed81e8e3">int32u</a> io, <a class="code" href="group__iar.html#ga2ba8e0357fdc7b7a450e6893ed81e8e3">int32u</a> config)
<a name="l00048"></a>00048 {
<a name="l00049"></a>00049   <span class="keyword">static</span> <span class="keyword">volatile</span> <a class="code" href="group__iar.html#ga2ba8e0357fdc7b7a450e6893ed81e8e3">int32u</a> *<span class="keyword">const</span> configRegs[] = 
<a name="l00050"></a>00050     { (<span class="keyword">volatile</span> <a class="code" href="group__iar.html#ga2ba8e0357fdc7b7a450e6893ed81e8e3">int32u</a> *)<a class="code" href="regs_8h.html#aeac195566b9be7b7de25ee53a3684bac">GPIO_PACFGL_ADDR</a>,
<a name="l00051"></a>00051       (<span class="keyword">volatile</span> <a class="code" href="group__iar.html#ga2ba8e0357fdc7b7a450e6893ed81e8e3">int32u</a> *)<a class="code" href="regs_8h.html#a563f99eb74a5efa752004edf2136f793">GPIO_PACFGH_ADDR</a>,
<a name="l00052"></a>00052       (<span class="keyword">volatile</span> <a class="code" href="group__iar.html#ga2ba8e0357fdc7b7a450e6893ed81e8e3">int32u</a> *)<a class="code" href="regs_8h.html#a174d8a313dc5ddb4098c015a6b0e850e">GPIO_PBCFGL_ADDR</a>,
<a name="l00053"></a>00053       (<span class="keyword">volatile</span> <a class="code" href="group__iar.html#ga2ba8e0357fdc7b7a450e6893ed81e8e3">int32u</a> *)<a class="code" href="regs_8h.html#adf7c6b49429d9ce74508ff7befb66dc4">GPIO_PBCFGH_ADDR</a>,
<a name="l00054"></a>00054       (<span class="keyword">volatile</span> <a class="code" href="group__iar.html#ga2ba8e0357fdc7b7a450e6893ed81e8e3">int32u</a> *)<a class="code" href="regs_8h.html#a81c4aa78a6689d3f094e6a55634d652e">GPIO_PCCFGL_ADDR</a>,
<a name="l00055"></a>00055       (<span class="keyword">volatile</span> <a class="code" href="group__iar.html#ga2ba8e0357fdc7b7a450e6893ed81e8e3">int32u</a> *)<a class="code" href="regs_8h.html#afe37a5699662fc539c327523d0ec31ab">GPIO_PCCFGH_ADDR</a> };
<a name="l00056"></a>00056   <a class="code" href="group__iar.html#ga2ba8e0357fdc7b7a450e6893ed81e8e3">int32u</a> portcfg;
<a name="l00057"></a>00057   portcfg = *configRegs[io/4];                <span class="comment">// get current config                   </span>
<a name="l00058"></a>00058   portcfg = portcfg &amp; ~((0xF)&lt;&lt;((io&amp;3)*4));   <span class="comment">// mask out config of this pin</span>
<a name="l00059"></a>00059   *configRegs[io/4] = portcfg | (config &lt;&lt;((io&amp;3)*4));
<a name="l00060"></a>00060 }
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="group__system__timer.html#gae0b935fd7ac5ee0070e31fb43bf82fba">00068</a> <a class="code" href="group__iar.html#ga409a5c4bea6981c30b308684efa33f6f">int16u</a> <a class="code" href="group__system__timer.html#gae0b935fd7ac5ee0070e31fb43bf82fba" title="Initializes the system tick.">halInternalStartSystemTimer</a>(<span class="keywordtype">void</span>)
<a name="l00069"></a>00069 {
<a name="l00070"></a>00070   <span class="comment">//Since the SleepTMR is the only timer maintained during deep sleep, it is</span>
<a name="l00071"></a>00071   <span class="comment">//used as the System Timer (RTC).  We maintain a 32 bit hardware timer</span>
<a name="l00072"></a>00072   <span class="comment">//configured for a tick value time of 1024 ticks/second (0.9765625 ms/tick)</span>
<a name="l00073"></a>00073   <span class="comment">//using either the 10 kHz internal SlowRC clock divided and calibrated to</span>
<a name="l00074"></a>00074   <span class="comment">//1024 Hz or the external 32.768 kHz crystal divided to 1024 Hz.</span>
<a name="l00075"></a>00075   <span class="comment">//With a tick time of ~1ms, this 32bit timer will wrap after ~48.5 days.</span>
<a name="l00076"></a>00076   
<a name="l00077"></a>00077   <span class="comment">//disable top-level interrupt while configuring</span>
<a name="l00078"></a>00078   <a class="code" href="regs_8h.html#a1d482f100610fd2c1d1c523e7e2324d2">INT_CFGCLR</a> = <a class="code" href="regs_8h.html#af81a6808df3b6f0f85a4b4b74fb26392">INT_SLEEPTMR</a>;
<a name="l00079"></a>00079   
<a name="l00080"></a>00080 <span class="preprocessor">  #ifdef ENABLE_OSC32K</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span><span class="preprocessor">    #ifdef DIGITAL_OSC32_EXT</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span>      <span class="comment">//Disable both OSC32K and SLOWRC if using external digital clock input</span>
<a name="l00083"></a>00083       <a class="code" href="regs_8h.html#a59b3a0b677455ae4ad804420c2fe6116">SLEEPTMR_CLKEN</a> = 0;
<a name="l00084"></a>00084 <span class="preprocessor">    #else</span>
<a name="l00085"></a>00085 <span class="preprocessor">      //Enable the 32kHz XTAL (and disable SlowRC since it is not needed)</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span>      <a class="code" href="regs_8h.html#a59b3a0b677455ae4ad804420c2fe6116">SLEEPTMR_CLKEN</a> = <a class="code" href="regs_8h.html#a753d77673c60d8b401c8e0311eb4c75f">SLEEPTMR_CLK32KEN</a>;
<a name="l00087"></a>00087 <span class="preprocessor">    #endif</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span>    <span class="comment">//Sleep timer configuration is the same for crystal and external clock</span>
<a name="l00089"></a>00089     <a class="code" href="regs_8h.html#a738ea93ecb502eebf3d138a8cf5a3be7">SLEEPTMR_CFG</a> = (<a class="code" href="regs_8h.html#ad9aa7235e41d8ac9d6227564c3b23404">SLEEPTMR_ENABLE</a>            | <span class="comment">//enable TMR</span>
<a name="l00090"></a>00090                    (0 &lt;&lt; <a class="code" href="regs_8h.html#a05291be157479096506ee2eb2a6bd697">SLEEPTMR_DBGPAUSE_BIT</a>)| <span class="comment">//TMR paused when halted</span>
<a name="l00091"></a>00091                    (5 &lt;&lt; <a class="code" href="regs_8h.html#a048b83a96193f0251354c0fbdf98a323">SLEEPTMR_CLKDIV_BIT</a>)  | <span class="comment">//divide down to 1024Hz</span>
<a name="l00092"></a>00092                    (1 &lt;&lt; <a class="code" href="regs_8h.html#ada6f249b675ae8f3402099e9dbc3b4b1">SLEEPTMR_CLKSEL_BIT</a>)) ; <span class="comment">//select XTAL</span>
<a name="l00093"></a>00093 <span class="preprocessor">  #else </span>
<a name="l00094"></a>00094 <span class="preprocessor">    //Enable the SlowRC (and disable 32kHz XTAL since it is not needed)</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>    <a class="code" href="regs_8h.html#a59b3a0b677455ae4ad804420c2fe6116">SLEEPTMR_CLKEN</a> = <a class="code" href="regs_8h.html#a138cc941d2dc101f50851bd549ccd9c5">SLEEPTMR_CLK10KEN</a>;
<a name="l00096"></a>00096     <a class="code" href="regs_8h.html#a738ea93ecb502eebf3d138a8cf5a3be7">SLEEPTMR_CFG</a> = (<a class="code" href="regs_8h.html#ad9aa7235e41d8ac9d6227564c3b23404">SLEEPTMR_ENABLE</a>            | <span class="comment">//enable TMR</span>
<a name="l00097"></a>00097                    (0 &lt;&lt; <a class="code" href="regs_8h.html#a05291be157479096506ee2eb2a6bd697">SLEEPTMR_DBGPAUSE_BIT</a>)| <span class="comment">//TMR paused when halted</span>
<a name="l00098"></a>00098                    (0 &lt;&lt; <a class="code" href="regs_8h.html#a048b83a96193f0251354c0fbdf98a323">SLEEPTMR_CLKDIV_BIT</a>)  | <span class="comment">//already 1024Hz</span>
<a name="l00099"></a>00099                    (0 &lt;&lt; <a class="code" href="regs_8h.html#ada6f249b675ae8f3402099e9dbc3b4b1">SLEEPTMR_CLKSEL_BIT</a>)) ; <span class="comment">//select SlowRC</span>
<a name="l00100"></a>00100 <span class="preprocessor">    #ifndef DISABLE_RC_CALIBRATION</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>      <a class="code" href="group__micro.html#ga4173faf01f05eb52ca815bec94193818" title="Calibrates the internal SlowRC to generate a 1024 Hz (1kHz) clock.">halInternalCalibrateSlowRc</a>(); <span class="comment">//calibrate SlowRC to 1024Hz</span>
<a name="l00102"></a>00102 <span class="preprocessor">    #endif//DISABLE_RC_CALIBRATION</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span><span class="preprocessor">  #endif//ENABLE_OSC32K</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span>  
<a name="l00105"></a>00105   <span class="comment">//clear out any stale interrupts</span>
<a name="l00106"></a>00106   <a class="code" href="regs_8h.html#a6faba36a14148b934777c410aba1f22d">INT_SLEEPTMRFLAG</a> = (<a class="code" href="regs_8h.html#a5744c22f661ba7564650b5c8daa473a7">INT_SLEEPTMRWRAP</a> | <a class="code" href="regs_8h.html#a5ddeb9dc5ac2c9a801e02a9082289d90">INT_SLEEPTMRCMPA</a> | <a class="code" href="regs_8h.html#a97d1234d6d7e89e2aa4379512648c2e1">INT_SLEEPTMRCMPB</a>);
<a name="l00107"></a>00107   <span class="comment">//turn off second level interrupts.  they will be enabled elsewhere as needed</span>
<a name="l00108"></a>00108   <a class="code" href="regs_8h.html#acf4b9b346663130244c0d7a09cd3bd19">INT_SLEEPTMRCFG</a> = <a class="code" href="regs_8h.html#a059aa2dbe60f49c673138d895f63deb8">INT_SLEEPTMRCFG_RESET</a>;
<a name="l00109"></a>00109   <span class="comment">//enable top-level interrupt</span>
<a name="l00110"></a>00110   <a class="code" href="regs_8h.html#a525cbdc1052b27f9778cf3048ae3f1a8">INT_CFGSET</a> = <a class="code" href="regs_8h.html#af81a6808df3b6f0f85a4b4b74fb26392">INT_SLEEPTMR</a>;
<a name="l00111"></a>00111   
<a name="l00112"></a>00112   <span class="keywordflow">return</span> 0;
<a name="l00113"></a>00113 }
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 
</pre></div></div>
<hr size="1">

<table border="0" cellspacing="0" cellpadding="0" width=100%>

<tr>

<td><address><small>

Hardware Abstraction Layer. <br>

1.0.1.

</small></address>

</td>

<td align="right">

<address><small>

Copyright &copy; 2009 by STMicrolectronics. All rights reserved.<br>

Generated Wed Sep 1 13:41:48 2010 with <a href="http://www.doxygen.org/index.html">Doxygen</a> 1.6.1.

</small></address>

</td>

</tr>

</table>

</body>

</html>
